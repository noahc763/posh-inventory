<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Barcode Labels</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  {% set _cols = (cols | int if cols is not none else 3) %}
  {% set _label_w = (preset.label_w if preset and preset.label_w is not none else '2.625in') %}
  {% set _label_h = (preset.label_h if preset and preset.label_h is not none else '1.0in') %}
  {% set _gap     = (preset.gap     if preset and preset.gap     is not none else '0.125in') %}
  {% set _margin  = (preset.margin  if preset and preset.margin  is not none else '0.5in') %}

  <style>
    :root{
      --label-w: {{ _label_w }};
      --label-h: {{ _label_h }};
      --gap:     {{ _gap }};
      --margin:  {{ _margin }};
      --cols:    {{ _cols }};
    }
  
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; }
  
    .sheet { /* ‚Ä¶ unchanged ‚Ä¶ */ }
    .grid  { /* ‚Ä¶ unchanged ‚Ä¶ */ }
  
    .label {
      box-sizing: border-box;
      padding: 4px 6px;
      overflow: hidden;
      border: 1px dashed #ddd; /* screen only */
      display: flex;
      flex-direction: column;      /* üîë title is a fixed row, image fills the rest */
      align-items: center;
      justify-content: stretch;    /* let inner flex decide spacing */
      gap: 4px;
      page-break-inside: avoid;
    }
  
    .title {
      flex: 0 0 auto;              /* üîë reserve space for title */
      font-size: 9.5pt;
      line-height: 1.15;
      text-align: center;
      width: 100%;
      display: -webkit-box;        /* clamp to two lines */
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: normal;         /* allow wrapping */
    }
  
    .imgwrap {
      flex: 1 1 auto;              /* üîë barcode gets the remaining height */
      min-height: 0;               /* allow it to shrink if needed */
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  
    .imgwrap img {
      max-width: 100%;
      max-height: 100%;            /* üîë scale to available space below title */
      object-fit: contain;
      display: block;
    }
  
    @media print {
      @page { size: auto; margin: 0; }
      body { margin: 0; }
      .toolbar { display: none; }
      .label { border: none; }
      .sheet { margin: 0 auto; }
    }
  </style>
    
</head>
<body>

<div class="toolbar">
  <button class="btn" onclick="window.print()">üñ®Ô∏è Print</button>
  <div class="info">
    Columns: {{ _cols }}{% if preset %} ¬∑ Preset: {{ _label_w }} √ó {{ _label_h }}{% endif %}
  </div>
</div>

<div class="sheet">
  <div class="grid">
    {% for lab in labels %}
      <div class="label">
        <div class="title">{{ lab.title }}</div>
        <div class="imgwrap">
          <img src="{{ lab.img }}" alt="Barcode {{ lab.barcode }}">
        </div>
      </div>
    {% endfor %}
  </div>
</div>

</body>
</html>
