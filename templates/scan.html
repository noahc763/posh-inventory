{% extends "base.html" %}
{% block content %}
<section class="card" style="max-width: 920px; margin: 0 auto;">
  <div class="card-header">
    <h2 style="margin:0;">Scan Item</h2>
    <p class="muted" style="margin:6px 0 0;">Scan a barcode or upload a photo. After we read the barcode, you can choose an existing category or create a new one.</p>
  </div>

  <div class="card-body" style="display:grid; gap:16px;">
    <!-- Status / barcode result -->
    <div id="status" class="muted" style="font-size:1rem;">Ready to scan.</div>

    <!-- Video + controls -->
    <div style="display:grid; gap:12px;">
      <video id="video" style="width:100%; max-height:360px; border-radius:12px; background:#000;"></video>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <button id="startBtn" class="btn">‚ñ∂ Start Camera</button>
        <button id="stopBtn" class="btn outline">‚èπ Stop</button>
        <label class="btn outline" for="fileInput">üì∑ Upload Photo</label>
        <input id="fileInput" type="file" accept="image/*" style="display:none;">
      </div>
    </div>

    <!-- After-scan actions -->
    <div id="postScan" style="display:none; border-top:1px solid #e6e6e6; padding-top:12px;">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
        <div>
          <div class="muted" style="font-size:0.95rem;">Detected barcode</div>
          <div id="barcodeValue" style="font-size:1.25rem; font-weight:600; letter-spacing:0.5px;"></div>
        </div>
        <div>
          <button id="rescanBtn" class="btn outline">‚Ü∫ Rescan</button>
        </div>
      </div>

      <!-- Existing vs new category -->
      <div style="display:grid; gap:10px; margin-top:12px;">
        <label style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
          <span style="min-width:120px;">Choose category</span>
          <select id="catSelect" style="min-width:240px; padding:8px 10px; border-radius:10px; border:1px solid #ccc;">
            <option value="" selected disabled>Select‚Ä¶</option>
            {% for c in categories %}
              <option value="{{ c.id }}">{{ c.name }}</option>
            {% endfor %}
          </select>
        </label>

        <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
          <span class="muted">or</span>
          <input id="newCatName" placeholder="New category name" style="min-width:240px; padding:8px 10px; border-radius:10px; border:1px solid #ccc;">
          <button id="createCatBtn" class="btn outline">+ Create</button>
        </div>

        <div style="display:flex; gap:8px; margin-top:8px;">
          <button id="continueBtn" class="btn">Continue</button>
        </div>
      </div>
    </div>
  </div>
</section>

<script src="https://unpkg.com/@zxing/library@0.21.2"></script>
<script>
  const statusEl = document.getElementById('status');
  const video = document.getElementById('video');
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  const fileInput = document.getElementById('fileInput');
  const postScan = document.getElementById('postScan');
  const barcodeValue = document.getElementById('barcodeValue');
  const catSelect = document.getElementById('catSelect');
  const newCatName = document.getElementById('newCatName');
  const createCatBtn = document.getElementById('createCatBtn');
  const continueBtn = document.getElementById('continueBtn');
  const rescanBtn = document.getElementById('rescanBtn');

  let codeReader = null;
  let stream = null;
  let lastBarcode = '';

  function setStatus(msg) {
    statusEl.textContent = msg;
  }

  async function startCamera() {
    try {
      if (!codeReader) {
        codeReader = new ZXing.BrowserMultiFormatReader();
      }
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
      video.srcObject = stream;
      video.setAttribute('playsinline', '');
      await video.play();
      scanLoop();
      setStatus('Camera started. Point at barcode‚Ä¶');
    } catch (e) {
      setStatus('Could not access camera: ' + e.message);
    }
  }

  async function stopCamera() {
    try {
      if (codeReader) {
        codeReader.reset();
      }
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
      setStatus('Camera stopped.');
    } catch (e) {
      setStatus('Error stopping camera: ' + e.message);
    }
  }

  async function scanLoop() {
    if (!codeReader) return;
    try {
      const result = await codeReader.decodeOnceFromVideoDevice(undefined, 'video');
      if (result && result.text) {
        handleBarcode(result.text);
      } else {
        requestAnimationFrame(scanLoop);
      }
    } catch (e) {
      // If user stopped, just quit
    }
  }

  function handleBarcode(raw) {
    lastBarcode = (raw || '').replace(/\D/g, '');
    if (!lastBarcode) {
      setStatus('Could not read a valid barcode. Try again.');
      return;
    }
    barcodeValue.textContent = lastBarcode;
    postScan.style.display = 'block';
    setStatus('Barcode detected.');
    stopCamera();
  }

  // Upload image path
  fileInput.addEventListener('change', () => {
    const file = fileInput.files?.[0];
    if (!file) return;
    const img = new Image();
    img.onload = async () => {
      try {
        if (!codeReader) codeReader = new ZXing.BrowserMultiFormatReader();
        const luminanceSource = await ZXing.BrowserBarcodeReader.loadImageElement(img);
        const hints = new ZXing.Map();
        const result = await codeReader.decodeBitmap(luminanceSource, hints);
        handleBarcode(result.text);
      } catch (err) {
        setStatus('No barcode detected in that image.');
      }
    };
    img.onerror = () => setStatus('Could not read image.');
    img.src = URL.createObjectURL(file);
  });

  startBtn.addEventListener('click', startCamera);
  stopBtn.addEventListener('click', stopCamera);
  rescanBtn.addEventListener('click', () => {
    postScan.style.display = 'none';
    lastBarcode = '';
    startCamera();
  });

  // Create category inline (POST to /api/categories)
  createCatBtn.addEventListener('click', async () => {
    const name = (newCatName.value || '').trim();
    if (!name) { alert('Enter a category name'); return; }
    try {
      const resp = await fetch('{{ url_for("categories.api_create_category") }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name })
      });
      const data = await resp.json();
      if (!data.ok) { alert(data.error || 'Could not create category'); return; }
      // add to select and select it
      const opt = document.createElement('option');
      opt.value = data.id;
      opt.textContent = data.name;
      let exists = false;
      Array.from(catSelect.options).forEach(o => { if (o.value == String(data.id)) exists = true; });
      if (!exists) catSelect.appendChild(opt);
      catSelect.value = String(data.id);
      newCatName.value = '';
    } catch (e) {
      alert('Failed to create category: ' + e.message);
    }
  });

  // Continue flow: go to /items/new?category_id=...&barcode=...
  continueBtn.addEventListener('click', () => {
    const catId = catSelect.value;
    if (!lastBarcode) { alert('Scan a barcode first.'); return; }
    if (!catId) { alert('Pick or create a category.'); return; }
    window.location.assign(`/items/new?category_id=${encodeURIComponent(catId)}&barcode=${encodeURIComponent(lastBarcode)}`);
  });
</script>
{% endblock %}
