{% extends "base.html" %}
{% block content %}
<section class="card">
  <div class="card-header">
    <h2 style="margin:0;">Scan a Barcode</h2>
  </div>
  <div class="card-body">
    <p class="muted">Tip: Allow camera access when prompted. On iPhone, use HTTPS and tap “Start Camera”.</p>

    <div class="row">
      <div class="field" style="min-width:240px;">
        <span>Category</span>
        <select id="categorySelect" required>
          <option value="" disabled selected>Select a category</option>
          {% for c in categories %}
            <option value="{{ c.id }}">{{ c.name }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <video id="preview" class="video" playsinline muted></video>

    <div class="row">
      <button id="startBtn" type="button" class="btn">Start Camera</button>
      <button id="stopBtn" type="button" class="btn" disabled>Stop</button>
      <label class="btn" style="margin-left:auto;">
        <input id="photoInput" type="file" accept="image/*" capture="environment" style="display:none">
        Upload Photo
      </label>
    </div>

    <div id="status" class="muted">Idle</div>
    <div id="result" style="margin-top:10px; font-weight:600; word-break:break-all;"></div>
    <canvas id="canvas" style="display:none;"></canvas>
  </div>
</section>

<script src="https://unpkg.com/@zxing/library@0.20.0"></script>
<script src="https://unpkg.com/jsqr@1.4.0/dist/jsQR.js"></script>
<script>
  const video = document.getElementById('preview');
  const startBtn = document.getElementById('startBtn');
  const stopBtn  = document.getElementById('stopBtn');
  const statusEl = document.getElementById('status');
  const resultEl = document.getElementById('result');
  const photoInput = document.getElementById('photoInput');
  const categorySelect = document.getElementById('categorySelect');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  let codeReader = null;

  const setStatus = (m) => statusEl.textContent = m;
  const setResult = (t) => resultEl.textContent = t ? `Scanned: ${t}` : '';
  const normalizeBarcode = (s) => String(s || '').trim();

  async function onBarcode(rawCode) {
    const barcode = normalizeBarcode(rawCode);
    const cat = categorySelect?.value;
    if (!barcode) return;
    if (!cat) { alert("Pick a category first."); return; }
    try {
      const r = await fetch(`/api/items/lookup?barcode=${encodeURIComponent(barcode)}`, { headers: { "Accept":"application/json" }});
      const data = await r.json();
      if (data.found) window.location.assign(`/items/${data.id}`);
      else window.location.assign(`/categories/${cat}/items/new?barcode=${encodeURIComponent(barcode)}`);
    } catch {
      window.location.assign(`/categories/${cat}/items/new?barcode=${encodeURIComponent(barcode)}`);
    }
  }

  async function startCamera() {
    setResult(''); setStatus('Requesting camera…');
    if (!navigator.mediaDevices?.getUserMedia) { setStatus('Camera API not supported. Use “Upload Photo”.'); return; }
    if (!codeReader) codeReader = new ZXing.BrowserMultiFormatReader(); else codeReader.reset();
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio:false, video:{ facingMode:{ideal:'environment'}, width:{ideal:1280}, height:{ideal:720} }});
      video.srcObject = stream; await video.play();
      setStatus('Scanning…'); startBtn.disabled = true; stopBtn.disabled = false;

      const decodeLoop = async () => {
        try {
          const result = await codeReader.decodeOnceFromVideoDevice(undefined, video);
          if (result?.text) { const code = result.text; setResult(code); setStatus('Found code. Redirecting…'); stopCamera(); onBarcode(code); return; }
        } catch (err) {
          if (!String(err).includes('NotFoundException')) setStatus('Scanning error: ' + (err?.message || err));
        }
        if (video.srcObject) requestAnimationFrame(decodeLoop);
      };
      requestAnimationFrame(decodeLoop);
    } catch (err) {
      if (err.name === 'NotAllowedError') setStatus('Camera permission denied.');
      else if (err.name === 'NotFoundError' || err.name === 'OverconstrainedError') setStatus('No suitable camera found.');
      else if (!window.isSecureContext) setStatus('Camera requires HTTPS.');
      else setStatus('Unable to access camera: ' + (err?.message || err));
    }
  }

  function stopCamera() {
    startBtn.disabled = false; stopBtn.disabled = true;
    codeReader?.reset();
    if (video.srcObject) { video.srcObject.getTracks().forEach(t => t.stop()); video.srcObject = null; }
  }

  photoInput.addEventListener('change', (e) => {
    const file = e.target.files?.[0]; if (!file) return;
    const img = new Image();
    img.onload = () => {
      canvas.width = img.width; canvas.height = img.height;
      ctx.drawImage(img, 0, 0);
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const qr = jsQR(imageData.data, canvas.width, canvas.height);
      if (qr?.data) { const code = qr.data; setResult(code); setStatus('Decoded from photo. Redirecting…'); onBarcode(code); return; }
      setStatus('Could not detect a QR code in that photo.');
    };
    img.onerror = () => setStatus('Could not read image.');
    img.src = URL.createObjectURL(file);
  });

  startBtn.addEventListener('click', startCamera);
  stopBtn.addEventListener('click', stopCamera);
  video.setAttribute('playsinline',''); video.setAttribute('muted','');
</script>
{% endblock %}
