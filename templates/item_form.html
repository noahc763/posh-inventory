{% extends "base.html" %}
{% block content %}
<section class="card" style="max-width: 760px; margin: 0 auto;">
  <div class="card-header">
    <h2>New Item</h2>
  </div>

  <div class="card-body">
    <form action="{{ url_for('items.add_item') }}"
          method="post"
          enctype="multipart/form-data"
          class="grid-form"
          style="display:grid; gap:12px;">

      <!-- Category -->
      <label class="field">
        <span>Category *</span>
        <div style="display:grid; gap:10px;">
          <select id="category_id" name="category_id" required>
            <option value="" selected>— Select —</option>
            {% for c in categories %}
              <option value="{{ c.id }}">{{ c.name }}</option>
            {% endfor %}
          </select>

          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
            <input id="newCatName" type="text" class="input" placeholder="New category name" style="max-width:260px;">
            <button id="createCatBtn" class="btn outline" type="button">+ Create category</button>
            <span class="muted small" id="createCatStatus" aria-live="polite"></span>
          </div>
        </div>
      </label>

      <!-- Title -->
      <label class="field">
        <span>Title *</span>
        <input name="title" placeholder="e.g., Nike Air Max 270" required />
      </label>

      <!-- Barcode -->
      <label class="field">
        <span>Barcode (UPC/EAN)</span>
        <input name="barcode" value="{{ prefill.barcode|default('') }}" placeholder="Scan or type" />
      </label>

      <!-- Prices -->
      <div class="grid-2">
        <label class="field">
          <span>Purchase Price *</span>
          <input id="purchase_price" name="purchase_price" type="number" step="0.01" min="0" placeholder="0.00" required />
        </label>

        <label class="field">
          <span>List Price</span>
          <input id="list_price" name="list_price" type="number" step="0.01" min="0" placeholder="0.00" />
          <span class="small muted">Auto-filled to breakeven. You can override.</span>
        </label>
      </div>

      <!-- Sold fields -->
      <div class="grid-2">
        <label class="field">
          <span>Sold Price</span>
          <input name="sold_price" type="number" inputmode="decimal" step="0.01" min="0" placeholder="0.00" />
        </label>

        <label class="field">
          <span>Sold Date</span>
          <input name="sold_date" type="date" />
        </label>
      </div>

      <!-- Fee / Profit preview -->
      <div class="grid-2">
        <label class="field">
          <span>Estimated Poshmark Fee (auto)</span>
          <input id="fee" name="platform_fee" type="number" step="0.01" min="0" placeholder="0.00" readonly />
        </label>

        <label class="field">
          <span>Estimated Profit (auto)</span>
          <input id="profit" type="number" step="0.01" placeholder="0.00" readonly />
        </label>
      </div>

      <!-- Breakeven -->
      <label class="field">
        <span>Breakeven Price (auto)</span>
        <input id="breakeven_price" type="number" step="0.01" placeholder="0.00" readonly />
        <span class="small muted">Lowest list price to cover purchase + Poshmark fee.</span>
      </label>

      <!-- Dates / Source -->
      <div class="grid-2">
        <label class="field">
          <span>Purchase Date</span>
          <input name="purchase_date" type="date" />
        </label>

        <label class="field">
          <span>Purchase Source</span>
          <input name="purchase_source" placeholder="Where did you buy it?" />
        </label>
      </div>

      <!-- Notes -->
      <label class="field">
        <span>Notes</span>
        <textarea name="notes" rows="3" placeholder="Details, flaws, source, etc."></textarea>
      </label>

      <!-- Photo -->
      <label class="field">
        <span>Photo</span>
        <input name="photo" type="file" accept="image/*" />
      </label>

      <div style="display:flex; gap:8px; margin-top:8px;">
        <button class="btn" type="submit">Save Item</button>
        <a class="btn outline" href="{{ url_for('dashboard') }}" role="button">Cancel</a>
      </div>
    </form>
  </div>
</section>

<script>
  // --- Inline category creation ---
  const createBtn = document.getElementById('createCatBtn');
  const nameInput = document.getElementById('newCatName');
  const selectEl  = document.getElementById('category_id');
  const statusEl  = document.getElementById('createCatStatus');

  async function createCategory() {
    const name = (nameInput.value || '').trim();
    if (!name) { alert('Enter a category name'); nameInput.focus(); return; }

    createBtn.disabled = true;
    statusEl.textContent = 'Creating…';

    try {
      const resp = await fetch('{{ url_for("categories.api_create_category") }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name })
      });
      const data = await resp.json();
      if (!resp.ok || !data.ok) throw new Error(data.error || ('HTTP ' + resp.status));

      const id = String(data.id);
      let present = false;
      for (const opt of selectEl.options) { if (opt.value === id) { present = true; break; } }
      if (!present) {
        const opt = document.createElement('option');
        opt.value = id;
        opt.textContent = data.name;
        selectEl.appendChild(opt);
      }
      selectEl.value = id;
      nameInput.value = '';
      statusEl.textContent = data.created ? 'Category created.' : 'Category already existed.';
    } catch (e) {
      alert('Could not create category: ' + e.message);
      statusEl.textContent = 'Failed.';
    } finally {
      createBtn.disabled = false;
      setTimeout(() => statusEl.textContent = '', 2000);
    }
  }

  createBtn?.addEventListener('click', createCategory);
  nameInput?.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') { e.preventDefault(); createCategory(); }
  });

  // --- Numbers & fee/profit/breakeven preview with auto-fill of List Price ---
  const purchaseEl = document.getElementById('purchase_price');
  const listEl     = document.getElementById('list_price');
  const feeEl      = document.getElementById('fee');
  const profitEl   = document.getElementById('profit');
  const breakEl    = document.getElementById('breakeven_price');

  function asNum(el){ const v = parseFloat((el?.value || '').replace(/[^\d.]/g,'')); return isNaN(v)?0:v; }
  function ceil2(x){ return Math.ceil(x * 100) / 100; }

  // Poshmark fee rules
  function poshmarkFee(listPrice){
    if (listPrice <= 0) return 0;
    return listPrice < 15 ? 2.95 : listPrice * 0.20;
  }

  // Breakeven using fee rules
  function breakeven(purchase){
    if (purchase <= 0) return 0;
    const flatCandidate = purchase + 2.95;   // valid only if < $15
    if (flatCandidate < 15) return ceil2(flatCandidate);
    const percentCandidate = purchase / 0.8; // 20% fee regime
    return ceil2(Math.max(15, percentCandidate));
  }

  // Track whether user has edited List Price
  listEl.dataset.autoFilled = "true";
  listEl.addEventListener('input', () => { listEl.dataset.autoFilled = "false"; });

  function recalc(){
    const purchase  = asNum(purchaseEl);
    const listPrice = asNum(listEl);

    // Compute breakeven
    const be = breakeven(purchase);
    breakEl.value = purchase ? be.toFixed(2) : '';

    // If user hasn't manually changed List Price, auto-fill it to breakeven
    if ((!listEl.value || listEl.dataset.autoFilled === "true") && purchase > 0) {
      listEl.value = be.toFixed(2);
      listEl.dataset.autoFilled = "true"; // still auto-controlled
    }

    // Fee & Profit based on current list price
    const fee = poshmarkFee(asNum(listEl));
    feeEl.value = listEl.value ? fee.toFixed(2) : '';
    const profit = listEl.value ? (asNum(listEl) - fee - purchase) : 0;
    profitEl.value = listEl.value ? profit.toFixed(2) : '';
  }

  purchaseEl?.addEventListener('input', recalc);
  window.addEventListener('DOMContentLoaded', recalc);
</script>
{% endblock %}
