{% extends "base.html" %}
{% block content %}
<section class="card" style="max-width: 760px; margin: 0 auto;">
  <div class="card-header">
    <h2>New Item{% if category %} in {{ category.name }}{% endif %}</h2>
  </div>

  <div class="card-body">
    <form action="{{ url_for('items_new') }}" method="post" enctype="multipart/form-data" class="grid-form" style="display:grid; gap:12px;">

      <label class="field">
        <span>Category *</span>
        <select name="category_id" required>
          <option value="" {% if not category %}selected{% endif %}>— Select —</option>
          {% for c in categories %}
            <option value="{{ c.id }}" {% if category and category.id == c.id %}selected{% endif %}>{{ c.name }}</option>
          {% endfor %}
        </select>
      </label>

      <label class="field">
        <span>Title *</span>
        <input name="title" placeholder="e.g., Nike Air Max 270" required />
      </label>

      <label class="field">
        <span>Barcode (UPC/EAN)</span>
        <input name="barcode" value="{{ prefill.barcode|default('') }}" placeholder="Scan or type" />
      </label>

      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
        <label class="field">
          <span>Size</span>
          <input name="size" placeholder="e.g., M, 8.5, 32x30" />
        </label>

        <label class="field">
          <span>Color</span>
          <input name="color" placeholder="e.g., Black / White" />
        </label>
      </div>

      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
        <label class="field">
          <span>Purchase Price *</span>
          <input id="purchase_price" name="purchase_price" type="number" step="0.01" min="0" placeholder="0.00" required />
        </label>

        <label class="field">
          <span>Listing Price</span>
          <input id="listing_price" name="listing_price" type="number" step="0.01" min="0" placeholder="0.00" />
        </label>
      </div>

      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
        <label class="field">
          <span>Estimated Poshmark Fee (auto)</span>
          <input id="fee" name="platform_fee" type="number" step="0.01" min="0" placeholder="0.00" readonly />
        </label>

        <label class="field">
          <span>Estimated Profit (auto)</span>
          <input id="profit" type="number" step="0.01" placeholder="0.00" readonly />
        </label>
      </div>

      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
        <label class="field">
          <span>Sold Price</span>
          <input name="sold_price" type="number" step="0.01" min="0" placeholder="0.00" />
        </label>

        <label class="field">
          <span>Sold Date</span>
          <input name="sold_date" type="date" />
        </label>
      </div>

      <label class="field">
        <span>Condition</span>
        <select name="condition">
          <option value="" selected>— Select —</option>
          <option value="New with tags">New with tags</option>
          <option value="New without tags">New without tags</option>
          <option value="Excellent used">Excellent used</option>
          <option value="Good used">Good used</option>
          <option value="Fair">Fair</option>
        </select>
      </label>

      <label class="field">
        <span>Notes</span>
        <textarea name="notes" rows="3" placeholder="Details, flaws, source, etc."></textarea>
      </label>

      <label class="field">
        <span>Photo</span>
        <input name="photo" type="file" accept="image/*" />
      </label>

      <div style="display:flex; gap:8px; margin-top:8px;">
        <button class="btn" type="submit">Save Item</button>
        <a class="btn outline" href="{{ url_for('dashboard') }}" role="button">Cancel</a>
      </div>
    </form>
  </div>
</section>

<script>
  const purchaseEl = document.getElementById('purchase_price');
  const listEl = document.getElementById('listing_price');
  const feeEl = document.getElementById('fee');
  const profitEl = document.getElementById('profit');

  function asNum(el) {
    const v = parseFloat((el?.value || '').replace(/[^\d.]/g, ''));
    return isNaN(v) ? 0 : v;
  }

  function poshmarkFee(listing) {
    if (listing <= 0) return 0;
    // Poshmark fee: $2.95 for items < $15, else 20%
    return listing < 15 ? 2.95 : listing * 0.20;
  }

  function recalc() {
    const purchase = asNum(purchaseEl);
    const listing = asNum(listEl);
    const fee = poshmarkFee(listing);
    feeEl.value = fee ? fee.toFixed(2) : '';
    const profit = listing - fee - purchase;
    profitEl.value = (listing ? profit.toFixed(2) : '');
  }

  purchaseEl?.addEventListener('input', recalc);
  listEl?.addEventListener('input', recalc);
  window.addEventListener('DOMContentLoaded', recalc);
</script>
{% endblock %}
