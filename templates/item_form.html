{% extends "base.html" %}
{% block content %}
<section class="card" style="max-width: 760px; margin: 0 auto;">
  <div class="card-header">
    <h2>New Item</h2>
  </div>

  <div class="card-body">
    <form action="{{ url_for('items_new') }}" method="post" enctype="multipart/form-data" class="grid-form" style="display:grid; gap:12px;">

      <!-- ONE category area: choose existing OR create inline -->
      <label class="field">
        <span>Category *</span>
        <div style="display:grid; gap:10px;">
          <select id="category_id" name="category_id" required>
            <option value="" {% if not category %}selected{% endif %}>— Select —</option>
            {% for c in categories %}
              <option value="{{ c.id }}" {% if category and category.id == c.id %}selected{% endif %}>{{ c.name }}</option>
            {% endfor %}
          </select>

          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
            <input id="newCatName" type="text" class="input" placeholder="New category name" style="max-width:260px;">
            <button id="createCatBtn" class="btn outline" type="button">+ Create category</button>
            <span class="muted small" id="createCatStatus" aria-live="polite"></span>
          </div>
        </div>
      </label>

      <label class="field">
        <span>Title *</span>
        <input name="title" placeholder="e.g., Nike Air Max 270" required />
      </label>

      <label class="field">
        <span>Barcode (UPC/EAN)</span>
        <input name="barcode" value="{{ prefill.barcode|default('') }}" placeholder="Scan or type" />
      </label>

      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
        <label class="field">
          <span>Size</span>
          <input name="size" placeholder="e.g., M, 8.5, 32x30" />
        </label>

        <label class="field">
          <span>Color</span>
          <input name="color" placeholder="e.g., Black / White" />
        </label>
      </div>

      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
        <label class="field">
          <span>Purchase Price *</span>
          <input id="purchase_price" name="purchase_price" type="number" step="0.01" min="0" placeholder="0.00" required />
        </label>

        <label class="field">
          <span>Listing Price</span>
          <input id="listing_price" name="listing_price" type="number" step="0.01" min="0" placeholder="0.00" />
        </label>
      </div>

      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
        <label class="field">
          <span>Estimated Poshmark Fee (auto)</span>
          <input id="fee" name="platform_fee" type="number" step="0.01" min="0" placeholder="0.00" readonly />
        </label>

        <label class="field">
          <span>Estimated Profit (auto)</span>
          <input id="profit" type="number" step="0.01" placeholder="0.00" readonly />
        </label>
      </div>

      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
        <label class="field">
          <span>Sold Price</span>
          <input name="sold_price" type="number" step="0.01" min="0" placeholder="0.00" />
        </label>

        <label class="field">
          <span>Sold Date</span>
          <input name="sold_date" type="date" />
        </label>
      </div>

      <label class="field">
        <span>Condition</span>
        <select name="condition">
          <option value="" selected>— Select —</option>
          <option value="New with tags">New with tags</option>
          <option value="New without tags">New without tags</option>
          <option value="Excellent used">Excellent used</option>
          <option value="Good used">Good used</option>
          <option value="Fair">Fair</option>
        </select>
      </label>

      <label class="field">
        <span>Notes</span>
        <textarea name="notes" rows="3" placeholder="Details, flaws, source, etc."></textarea>
      </label>

      <label class="field">
        <span>Photo</span>
        <input name="photo" type="file" accept="image/*" />
      </label>

      <div style="display:flex; gap:8px; margin-top:8px;">
        <button class="btn" type="submit">Save Item</button>
        <a class="btn outline" href="{{ url_for('dashboard') }}" role="button">Cancel</a>
      </div>
    </form>
  </div>
</section>

<script>
  // --- Inline category creation ---
  const createBtn = document.getElementById('createCatBtn');
  const nameInput = document.getElementById('newCatName');
  const selectEl  = document.getElementById('category_id');
  const statusEl  = document.getElementById('createCatStatus');

  async function createCategory() {
    const name = (nameInput.value || '').trim();
    if (!name) { alert('Enter a category name'); nameInput.focus(); return; }

    createBtn.disabled = true;
    statusEl.textContent = 'Creating…';

    try {
      const resp = await fetch('{{ url_for("categories.api_create_category") }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name })
      });
      const data = await resp.json();
      if (!resp.ok || !data.ok) {
        throw new Error(data.error || ('HTTP ' + resp.status));
      }

      // add to select if not present
      const id = String(data.id);
      let present = false;
      for (const opt of selectEl.options) { if (opt.value === id) { present = true; break; } }
      if (!present) {
        const opt = document.createElement('option');
        opt.value = id;
        opt.textContent = data.name;
        selectEl.appendChild(opt);
      }
      selectEl.value = id;
      nameInput.value = '';
      statusEl.textContent = data.created ? 'Category created.' : 'Category already existed.';
    } catch (e) {
      alert('Could not create category: ' + e.message);
      statusEl.textContent = 'Failed.';
    } finally {
      createBtn.disabled = false;
      setTimeout(() => statusEl.textContent = '', 2000);
    }
  }

  createBtn?.addEventListener('click', createCategory);
  nameInput?.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') { e.preventDefault(); createCategory(); }
  });

  // --- Fee/profit preview ---
  const purchaseEl = document.getElementById('purchase_price');
  const listEl = document.getElementById('listing_price');
  const feeEl = document.getElementById('fee');
  const profitEl = document.getElementById('profit');

  function asNum(el){ const v = parseFloat((el?.value || '').replace(/[^\d.]/g,'')); return isNaN(v)?0:v; }
  function poshmarkFee(listing){ if(listing<=0) return 0; return listing < 15 ? 2.95 : listing * 0.20; }
  function recalc(){
    const purchase = asNum(purchaseEl);
    const listing = asNum(listEl);
    const fee = poshmarkFee(listing);
    feeEl.value = fee ? fee.toFixed(2) : '';
    profitEl.value = listing ? (listing - fee - purchase).toFixed(2) : '';
  }
  purchaseEl?.addEventListener('input', recalc);
  listEl?.addEventListener('input', recalc);
  window.addEventListener('DOMContentLoaded', recalc);
</script>
{% endblock %}
