{% extends "base.html" %}
{% block content %}
<section class="card" style="max-width: 760px; margin: 0 auto;">
  <div class="card-header">
    <h2>New Item</h2>
  </div>

  <div class="card-body">
    <form action="{{ url_for('items.add_item') }}"
          method="post"
          enctype="multipart/form-data"
          class="grid-form"
          style="display:grid; gap:12px;">

      <!-- Category -->
      <label class="field">
        <span>Category *</span>
        <div style="display:grid; gap:10px;">
          <select id="category_id" name="category_id" required>
            <option value="" selected>— Select —</option>
            {% for c in categories %}
              <option value="{{ c.id }}">{{ c.name }}</option>
            {% endfor %}
          </select>

          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
            <input id="newCatName" type="text" class="input" placeholder="New category name" style="max-width:260px;">
            <button id="createCatBtn" class="btn outline" type="button">+ Create category</button>
            <span class="muted small" id="createCatStatus" aria-live="polite"></span>
          </div>
        </div>
      </label>

      <!-- Title -->
      <label class="field">
        <span>Title *</span>
        <input name="title" placeholder="e.g., Nike Air Max 270" required />
      </label>

      <!-- Barcode -->
      <label class="field">
        <span>Barcode (UPC/EAN)</span>
        <input name="barcode" value="{{ prefill.barcode|default('') }}" placeholder="Scan or type" />
      </label>

      <!-- Prices -->
      <div class="grid-2">
        <label class="field">
          <span>Purchase Price *</span>
          <input id="purchase_price" name="purchase_price" type="number" step="0.01" min="0" placeholder="0.00" required />
        </label>

        <label class="field">
          <span>List Price</span>
          <input id="list_price" name="list_price" type="number" step="0.01" min="0" placeholder="0.00" />
          <span class="small muted">Auto-filled to breakeven. You can override.</span>
        </label>
      </div>

      <!-- Sold fields -->
      <div class="grid-2">
        <label class="field">
          <span>Sold Price</span>
          <input name="sold_price" type="number" inputmode="decimal" step="0.01" min="0" placeholder="0.00" />
        </label>

        <label class="field">
          <span>Sold Date</span>
          <input name="sold_date" type="date" />
        </label>
      </div>

      <!-- Fee / Profit preview -->
      <div class="grid-2">
        <label class="field">
          <span>Estimated Poshmark Fee (auto)</span>
          <input id="fee" name="platform_fee" type="number" step="0.01" min="0" placeholder="0.00" readonly />
        </label>

        <label class="field">
          <span>Estimated Profit (auto)</span>
          <input id="profit" type="number" step="0.01" placeholder="0.00" readonly />
        </label>
      </div>

      <!-- Breakeven -->
      <label class="field">
        <span>Breakeven Price (auto)</span>
        <input id="breakeven_price" type="number" step="0.01" placeholder="0.00" readonly />
        <span class="small muted">Lowest list price to cover purchase + Poshmark fee.</span>
      </label>

      <!-- Dates / Source -->
      <div class="grid-2">
        <label class="field">
          <span>Purchase Date</span>
          <input name="purchase_date" type="date" />
        </label>

        <label class="field">
          <span>Purchase Source</span>
          <input name="purchase_source" placeholder="Where did you buy it?" />
        </label>
      </div>

      <!-- Notes -->
      <label class="field">
        <span>Notes</span>
        <textarea name="notes" rows="3" placeholder="Details, flaws, source, etc."></textarea>
      </label>

      <!-- Photo -->
      <label class="field">
        <span>Photo</span>
        <input name="photo" type="file" accept="image/*" />
      </label>

      <div style="display:flex; gap:8px; margin-top:8px;">
        <button class="btn" type="submit">Save Item</button>
        <a class="btn outline" href="{{ url_for('dashboard') }}" role="button">Cancel</a>
      </div>
    </form>
  </div>
</section>
<script>
  // --- Inline category creation ---
  const createBtn = document.getElementById('createCatBtn');
  const nameInput = document.getElementById('newCatName');
  const selectEl  = document.getElementById('category_id');
  const statusEl  = document.getElementById('createCatStatus');

  async function createCategory() {
    const name = (nameInput?.value || '').trim();
    if (!name) { alert('Enter a category name'); nameInput?.focus(); return; }

    createBtn.disabled = true;
    statusEl.textContent = 'Creating…';

    try {
      const resp = await fetch('{{ url_for("categories.api_create_category") }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name })
      });
      const data = await resp.json();
      if (!resp.ok || !data.ok) throw new Error(data.error || ('HTTP ' + resp.status));

      const id = String(data.id);
      let present = false;
      for (const opt of selectEl.options) { if (opt.value === id) { present = true; break; } }
      if (!present) {
        const opt = document.createElement('option');
        opt.value = id;
        opt.textContent = data.name;
        selectEl.appendChild(opt);
      }
      selectEl.value = id;
      nameInput.value = '';
      statusEl.textContent = data.created ? 'Category created.' : 'Category already existed.';
    } catch (e) {
      alert('Could not create category: ' + e.message);
      statusEl.textContent = 'Failed.';
    } finally {
      createBtn.disabled = false;
      setTimeout(() => statusEl.textContent = '', 2000);
    }
  }

  createBtn?.addEventListener('click', createCategory);
  nameInput?.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') { e.preventDefault(); createCategory(); }
  });

  // --- Fee / Profit / Breakeven (and auto-fill List Price) ---
  const purchaseEl = document.getElementById('purchase_price');
  const listEl     = document.getElementById('list_price');
  const feeEl      = document.getElementById('fee');
  const profitEl   = document.getElementById('profit');
  const breakEl    = document.getElementById('breakeven_price');

  function asNum(el){
    if (!el) return 0;
    const raw = (el.value || '').replace(/[^\d.]/g,'');
    const v = parseFloat(raw);
    return isNaN(v) ? 0 : v;
  }
  function ceil2(x){ return Math.ceil(x * 100) / 100; }

  // Poshmark fee: $2.95 if list < $15, else 20%
  function poshmarkFee(listing){
    if (listing <= 0) return 0;
    return listing < 15 ? 2.95 : listing * 0.20;
  }

  // Breakeven (same logic as server): min L s.t. L - fee(L) - purchase >= 0
  function breakeven(purchase){
    if (purchase <= 0) return 0;
    const flatCandidate = purchase + 2.95;   // only valid if < 15
    if (flatCandidate < 15) return ceil2(flatCandidate);
    const percentCandidate = purchase / 0.8; // 20% fee regime
    return ceil2(Math.max(15, percentCandidate));
  }

  // Tracks the last auto-set list price so user edits aren't overridden
  let lastAutoList = null;

  function recalc(andAutoFillList = false){
    const purchase = asNum(purchaseEl);
    const listing  = asNum(listEl);

    // Breakeven
    const be = purchase ? breakeven(purchase) : 0;
    if (breakEl) breakEl.value = purchase ? be.toFixed(2) : '';

    // Auto-fill list price if (a) asked to or (b) list is empty or equals the last auto-set
    if (listEl) {
      const currentListText = (listEl.value || '').trim();
      const currentList = listing;
      const shouldAuto =
        andAutoFillList ||
        currentListText === '' ||
        (lastAutoList !== null && currentList === lastAutoList);

      if (purchase && shouldAuto) {
        listEl.value = be.toFixed(2);
        lastAutoList = be;
      }
    }

    // Fee & Profit (based on whatever is in listEl now)
    const listNow = asNum(listEl);
    const fee = poshmarkFee(listNow);
    if (feeEl)    feeEl.value    = listNow ? fee.toFixed(2) : '';
    if (profitEl) profitEl.value = listNow ? (listNow - fee - purchase).toFixed(2) : '';
  }

  // Recalc whenever purchase or list changes.
  purchaseEl?.addEventListener('input', () => recalc(true));  // also auto-fill list on purchase change
  listEl?.addEventListener('input', () => {
    lastAutoList = null; // user's typing cancels auto-lock
    recalc(false);
  });

  // Initial pass after DOM is ready
  window.addEventListener('DOMContentLoaded', () => recalc(true));
</script>

{% endblock %}
