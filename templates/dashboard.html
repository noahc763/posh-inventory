{% extends "base.html" %}
{% block content %}

<section class="card">
  <div class="card-header" style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;">
    <h2 style="margin:0;">Dashboard</h2>

    <!-- Filters / actions -->
    <form method="get" action="{{ url_for('dashboard') }}" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
      <select name="category" aria-label="Filter by category" class="input">
        <option value="">All categories</option>
        {% for c in categories %}
          <option value="{{ c.id }}" {% if selected_cat == c.id %}selected{% endif %}>{{ c.name }}</option>
        {% endfor %}
      </select>
      <button class="btn outline" type="submit">Filter</button>

      <!-- Manual Add -->
      <div style="display:flex;gap:8px;align-items:center;">
        <select id="manualAddCategory" class="input" aria-label="Choose category" style="min-width:200px;">
          <option value="" {% if not selected_cat %}selected{% endif %} disabled>Select category‚Ä¶</option>
          {% for c in categories %}
            <option value="{{ c.id }}" {% if selected_cat == c.id %}selected{% endif %}>{{ c.name }}</option>
          {% endfor %}
        </select>
        <button class="btn" type="button" id="manualAddBtn">+ Add item</button>
      </div>
    </form>
  </div>

  <div class="card-body">
    <!-- Bulk actions -->
    <div style="display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-bottom:10px;">
      <button id="btnPrintSelected" class="btn outline" type="button">üñ®Ô∏è Print selected labels</button>

      <form id="bulkDeleteForm" method="post" action="{{ url_for('items.bulk_delete_items') }}" style="display:inline">
        <input type="hidden" name="ids" id="bulkDeleteIds">
        <button class="btn danger" type="submit">üóëÔ∏è Delete selected</button>
      </form>
    </div>

    <!-- Styles -->
    <style>
      .table-wrap{width:100%;overflow-x:auto;-webkit-overflow-scrolling:touch}
      .table{min-width:920px}

      .item-thumb-cell{width:56px}
      .item-thumb{width:48px;height:48px;border-radius:8px;overflow:hidden;background:#eef2f7;border:1px solid #d9e0ea;margin:auto}
      .item-thumb img{display:block;width:100%;height:100%;object-fit:cover;cursor:pointer;transform:none !important;image-orientation:from-image}

      .item-title{font-weight:600;color:inherit;text-decoration:none}
      .item-title:hover{text-decoration:underline}

      /* lightbox */
      .img-modal{display:none;position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,.9)}
      .img-modal.open{display:block}
      .img-modal__close{position:absolute;top:16px;right:20px;color:#fff;font-size:34px;font-weight:700;cursor:pointer;line-height:1;}
      .img-modal__body{display:flex;align-items:center;justify-content:center;width:100%;height:100%;padding:24px}
      .img-modal__img{display:block;max-width:92vw;max-height:86vh;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    </style>

    <div class="table-wrap">
      <table class="table">
        <thead>
          <tr>
            <th style="width:36px;text-align:center;">
              <input id="chkAll" type="checkbox" aria-label="Select all" />
            </th>
            <th class="item-thumb-cell">Image</th>
            <th>Title</th>
            <th>Category</th>
            <th>Barcode</th>
            <th>Purchase</th>
            <th>List</th>
            <th>Sold</th>
            <th class="right">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% if items|length == 0 %}
            <tr><td colspan="9" class="muted">No items yet. Use <em>+ Add item</em>.</td></tr>
          {% else %}
            {% for it in items %}
              <tr>
                <td style="text-align:center;">
                  <input class="chkItem" type="checkbox" value="{{ it.id }}" aria-label="Select item {{ it.id }}" />
                </td>

                <!-- IMAGE -->
                <td class="item-thumb-cell">
                  {% set img_url = None %}
                  {% if it.photo_path %}
                    {% set p = (it.photo_path|string).strip() %}
                    {% if p.startswith('http://') or p.startswith('https://') %}
                      {% set img_url = p %}
                    {% elif p.startswith('uploads/') %}
                      {% set img_url = url_for('static', filename=p) %}
                    {% elif p.startswith('/static/uploads/') %}
                      {% set img_url = p %}
                    {% endif %}
                  {% endif %}

                  {% if img_url %}
                    <div class="item-thumb">
                      <img src="{{ img_url }}{% if it.updated_at %}?v={{ it.updated_at|int }}{% endif %}"
                           alt="Photo of {{ it.title or it.name }}"
                           onclick="openImgModal(this.src)"
                           loading="lazy"
                           decoding="async"
                           onerror="this.closest('.item-thumb').style.display='none';">
                    </div>
                  {% else %}
                    <div class="muted small" style="text-align:center">No photo</div>
                  {% endif %}
                </td>

                <!-- TITLE -->
                <td>
                  <a class="item-title" href="{{ url_for('item_detail', item_id=it.id) }}">{{ it.title or it.name }}</a>
                </td>

                <td>{{ it.category.name if it.category else "‚Äî" }}</td>
                <td>{% if it.barcode %}<code>{{ it.barcode }}</code>{% else %}<span class="muted">‚Äî</span>{% endif %}</td>
                <td>{% if it.purchase_price is not none %}${{ '%.2f'|format(it.purchase_price) }}{% else %}‚Äî{% endif %}</td>
                <td>{% if it.list_price is not none %}${{ '%.2f'|format(it.list_price) }}{% else %}‚Äî{% endif %}</td>
                <td>{% if it.sold_price is not none %}${{ '%.2f'|format(it.sold_price) }}{% else %}‚Äî{% endif %}</td>

                <td style="padding:8px 10px;text-align:right;white-space:nowrap;">
                  <a class="btn" href="{{ url_for('item_detail', item_id=it.id) }}">View</a>
                  <a class="btn" href="{{ url_for('items.edit_item', item_id=it.id) }}">Edit</a>
                  <form method="post" action="{{ url_for('items.bulk_delete_items') }}"
                        style="display:inline" onsubmit="return confirm('Delete permanently?');">
                    <input type="hidden" name="ids" value="{{ it.id }}">
                    <button class="btn danger" type="submit">Delete</button>
                  </form>
                </td>
              </tr>
            {% endfor %}
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</section>

<!-- Lightbox -->
<div id="imgModal" class="img-modal" onclick="closeImgModal(event)">
  <span class="img-modal__close" onclick="closeImgModal(event)">&times;</span>
  <div class="img-modal__body">
    <img id="imgModalImg" class="img-modal__img" alt="Preview">
  </div>
</div>

<script>
(function(){
  const $ = (s,r=document)=>r.querySelector(s);
  const $$= (s,r=document)=>Array.from(r.querySelectorAll(s));

  // Manual Add
  $('#manualAddBtn')?.addEventListener('click',()=>{
    const cat=$('#manualAddCategory')?.value;
    if(!cat){alert('Pick a category first.');return;}
    window.location.assign(`/items/new?category_id=${encodeURIComponent(cat)}`);
  });

  // Select all
  $('#chkAll')?.addEventListener('change',e=>{
    $$('.chkItem').forEach(cb=>cb.checked=e.target.checked);
  });

  // Print selected
  $('#btnPrintSelected')?.addEventListener('click',()=>{
    const ids=$$('.chkItem').filter(cb=>cb.checked).map(cb=>cb.value);
    if(!ids.length){alert('Select at least one item.');return;}
    const url=`/labels/print?ids=${encodeURIComponent(ids.join(','))}&cols=1&dpi=203&copies=1`;
    window.open(url,'_blank','noopener');
  });

  // Bulk delete
  $('#bulkDeleteForm')?.addEventListener('submit',e=>{
    const ids=$$('.chkItem').filter(cb=>cb.checked).map(cb=>cb.value);
    if(!ids.length){e.preventDefault();alert('Select items first.');return;}
    if(!confirm(`Delete ${ids.length} item(s)? This cannot be undone.`)){e.preventDefault();}
    $('#bulkDeleteIds').value=ids.join(',');
  });
})();

function openImgModal(src){
  const m=document.getElementById('imgModal');
  const img=document.getElementById('imgModalImg');
  img.src=src;
  m.classList.add('open');
  document.body.style.overflow='hidden';
}
function closeImgModal(ev){
  if(ev && ev.target && !ev.target.closest('.img-modal__close') && ev.target.id!=='imgModal')return;
  const m=document.getElementById('imgModal');
  m.classList.remove('open');
  document.getElementById('imgModalImg').src='';
  document.body.style.overflow='';
}
</script>

{% endblock %}
