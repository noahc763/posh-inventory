{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-3">

    <!-- Header + actions + category filter -->
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">

      <div class="d-flex flex-wrap align-items-center gap-3">
        <h1 class="h3 mb-0">Inventory Dashboard</h1>
  
        <!-- Category filter -->
        <form method="get" class="d-flex align-items-center gap-2">
          <label for="category-filter" class="small text-muted mb-0">Category:</label>
          <select
            id="category-filter"
            name="category"
            class="form-select form-select-sm"
            onchange="this.form.submit()"
          >
            <option value="">All</option>
            {% for cat in categories %}
              <option value="{{ cat.id }}"
                {% if selected_cat == cat.id %}selected{% endif %}>
                {{ cat.name }}
              </option>
            {% endfor %}
          </select>
          <noscript>
            <button type="submit" class="btn btn-outline-secondary btn-sm">Filter</button>
          </noscript>
        </form>
      </div>
  
      <div class="d-flex gap-2">
        <a href="{{ url_for('items.add_item') }}" class="btn btn-primary btn-sm">
          + Add Item
        </a>
        <button form="labels-form" type="submit" class="btn btn-outline-secondary btn-sm">
          Print Selected Labels
        </button>
      </div>
    </div>
  

  <!-- Profit summary card -->
  <div class="row g-3 mb-3">
    <div class="col-6 col-md-3">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <div class="text-muted text-uppercase small mb-1">Estimated Profit</div>
          <div class="h5 mb-0">
            {% if total_estimated_profit is not none %}
              ${{ '{:,.2f}'.format(total_estimated_profit) }}
            {% else %}—{% endif %}
          </div>
          <div class="small text-muted">Unsold items</div>
        </div>
      </div>
    </div>
    <!-- You can add more cards here (inventory count, avg profit, etc.) -->
  </div>

  <!-- Items table -->
  <div class="card shadow-sm">
    <div class="card-body p-0">
      <div class="table-responsive">
        <form id="labels-form" method="post" action="{{ url_for('labels.labels_print') }}">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light sticky-top">
              <tr>
                <th scope="col" style="width: 40px;">
                  <input type="checkbox" id="select-all">
                </th>
                <th scope="col">Photo</th>
                <th scope="col">Title</th>
                <th scope="col">Barcode</th>
                <th scope="col">Category</th>
                <th scope="col" class="text-end">Purchase</th>
                <th scope="col" class="text-end">Price</th>
                <th scope="col" class="text-end">Profit</th>
                <th scope="col" class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for item in items %}
              <tr>
                <!-- checkbox for labels -->
                <td>
                  <input type="checkbox" name="item_ids" value="{{ item.id }}" class="row-check">
                </td>

                <!-- thumbnail -->
                <td style="width: 80px;">
                  {# Prefer photo_path; fallback to photo_filename if it exists #}
                  {% set photo = None %}
                  {% if item.photo_path is defined and item.photo_path %}
                    {% set photo = item.photo_path %}
                  {% elif item.photo_filename is defined and item.photo_filename %}
                    {% set photo = item.photo_filename %}
                  {% endif %}

                  {% if photo %}
                    <a href="{{ media_url(photo) }}" target="_blank">
                      <img
                        src="{{ media_url(photo) }}"
                        alt="Item photo"
                        class="img-thumbnail"
                        style="width:64px;height:64px;object-fit:cover;"
                      >
                    </a>
                  {% else %}
                    <span class="text-muted small">No photo</span>
                  {% endif %}
                </td>


                <!-- title / details -->
                <td>
                  <div class="fw-semibold">{{ item.title }}</div>
                  {% if item.brand or item.size %}
                    <div class="small text-muted">
                      {% if item.brand %}{{ item.brand }}{% endif %}
                      {% if item.size %} • Size {{ item.size }}{% endif %}
                    </div>
                  {% endif %}
                </td>

                <!-- barcode -->
                <td class="small text-muted">
                  {% if item.barcode is defined and item.barcode %}
                    {{ item.barcode }}
                  {% else %}
                    —
                  {% endif %}
                </td>

                <!-- category -->
                <td class="small text-muted">
                  {{ item.category.name if item.category else '' }}
                </td>

                <!-- purchase price -->
                <td class="text-end small">
                  {% if item.purchase_price is not none %}
                    ${{ '{:,.2f}'.format(item.purchase_price) }}
                  {% else %}
                    —
                  {% endif %}
                </td>

                <!-- list/sold price -->
                <td class="text-end small">
                  {% if item.price is defined and item.price is not none %}
                    ${{ '{:,.2f}'.format(item.price) }}
                  {% elif item.list_price is defined and item.list_price is not none %}
                    ${{ '{:,.2f}'.format(item.list_price) }}
                  {% elif item.sold_price is defined and item.sold_price is not none %}
                    ${{ '{:,.2f}'.format(item.sold_price) }}
                  {% else %}
                    —
                  {% endif %}
                </td>


                <!-- PROFIT -->
                <td class="text-end">
                  {% if item.profit is defined and item.profit is not none %}
                    {% if item.profit >= 0 %}
                      <span class="text-success">
                        ${{ '{:,.2f}'.format(item.profit) }}
                      </span>
                    {% else %}
                      <span class="text-danger">
                        ${{ '{:,.2f}'.format(item.profit) }}
                      </span>
                    {% endif %}
                  {% else %}
                    <span class="text-muted small">N/A</span>
                  {% endif %}
                </td>

                <!-- actions -->
                <td class="text-end">
                  <a href="{{ url_for('items.edit_item', item_id=item.id) }}"
                     class="btn btn-outline-secondary btn-sm">
                    Edit
                  </a>
                </td>
              </tr>
              {% else %}
              <tr>
                <td colspan="10" class="text-center py-4 text-muted">
                  No items yet. <a href="{{ url_for('items.add_item') }}">Add your first item</a>.
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Select-all logic -->
<script>
  const selectAll = document.getElementById('select-all');
  if (selectAll) {
    selectAll.addEventListener('change', function (e) {
      document.querySelectorAll('.row-check').forEach(cb => {
        cb.checked = e.target.checked;
      });
    });
  }
</script>
{% endblock %}
