{% extends "base.html" %}
{% block content %}

<section class="card">
  <div class="card-header" style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
    <h2 style="margin:0;">{{ 'Edit item' if item else 'Add item' }}</h2>
  </div>

  <div class="card-body">
    <form
      method="post"
      enctype="multipart/form-data"
      action="{% if item %}{{ url_for('items.edit_item', item_id=item.id) }}{% else %}{{ url_for('items.add_item') }}{% endif %}"
      class="form"
      style="display:grid;grid-template-columns:1fr 1fr;gap:14px;"
    >

      <!-- Title -->
      <div class="field">
        <label>Title</label>
        <input name="title" required placeholder="Item title" value="{{ item.title if item else '' }}" />
      </div>

      <!-- Barcode -->
      <div class="field">
        <label>Barcode (UPC/EAN)</label>
        <input name="barcode" placeholder="e.g., 012345678905"
               value="{% if item %}{{ item.barcode or '' }}{% else %}{{ (prefill.barcode if prefill else '') or '' }}{% endif %}" />
      </div>

      <!-- Category -->
      <div class="field">
        <label>Category</label>
        <select name="category_id" class="input">
          <option value="">— None —</option>
          {% for c in categories %}
            <option value="{{ c.id }}"
              {% if (item and item.category_id == c.id) or (not item and prefill and prefill.category_id and prefill.category_id|int == c.id) %}
                selected
              {% endif %}
            >{{ c.name }}</option>
          {% endfor %}
        </select>

        <script>
          const purchaseEl = document.getElementById('purchase_price');
          const listEl = document.getElementById('listing_price');
          const feeEl = document.getElementById('fee');
          const profitEl = document.getElementById('profit');
          const breakEl = document.getElementById('breakeven_price');
        
          function asNum(el){ const v = parseFloat((el?.value || '').replace(/[^\d.]/g,'')); return isNaN(v)?0:v; }
          function ceil2(x){ return Math.ceil(x * 100) / 100; }
        
          // Poshmark fee: $2.95 for items < $15, else 20%
          function poshmarkFee(listing){ if(listing<=0) return 0; return listing < 15 ? 2.95 : listing * 0.20; }
        
          // Minimum list price that makes profit >= 0 (piecewise)
          function breakeven(purchase){
            if (purchase <= 0) return 0;
            const flatCandidate = purchase + 2.95;
            if (flatCandidate < 15) return ceil2(flatCandidate);
            const percentCandidate = purchase / 0.8;
            return ceil2(Math.max(15, percentCandidate));
          }
        
          function recalc(){
            const purchase = asNum(purchaseEl);
            const listing = asNum(listEl);
        
            // Fee and profit from current listing
            const fee = poshmarkFee(listing);
            feeEl.value = listing ? fee.toFixed(2) : '';
            const profit = listing ? (listing - fee - purchase) : 0;
            profitEl.value = listing ? profit.toFixed(2) : '';
        
            // Breakeven
            const be = breakeven(purchase);
            breakEl.value = purchase ? be.toFixed(2) : '';
        
            // Auto-fill List Price if empty OR force update
            if (!listEl.value || listEl.dataset.autoFilled === "true") {
              listEl.value = be.toFixed(2);
              listEl.dataset.autoFilled = "true"; // mark as auto-filled so user can override
            }
          }
        
          purchaseEl?.addEventListener('input', recalc);
          listEl?.addEventListener('input', () => { listEl.dataset.autoFilled = "false"; }); // user override
          window.addEventListener('DOMContentLoaded', recalc);
        </script>
      </div>

      <!-- Purchase source -->
      <div class="field">
        <label>Purchase source</label>
        <input name="purchase_source" placeholder="Where did you buy it?" value="{{ item.purchase_source if item else '' }}" />
      </div>

      <!-- Purchase price -->
      <div class="field">
        <label>Purchase price</label>
        <input name="purchase_price" type="number" inputmode="decimal" step="0.01" min="0"
               value="{{ '%.2f'|format(item.purchase_price) if item and item.purchase_price is not none else '' }}" />
      </div>

      <!-- Purchase date -->
      <div class="field">
        <label>Purchase date</label>
        <input name="purchase_date" type="date"
               value="{{ item.purchase_date.strftime('%Y-%m-%d') if item and item.purchase_date else '' }}" />
      </div>

      <!-- List price -->
      <div class="field">
        <label>List price</label>
        <input name="list_price" type="number" inputmode="decimal" step="0.01" min="0"
               value="{{ '%.2f'|format(item.list_price) if item and item.list_price is not none else '' }}" />
      </div>

      <!-- Sold price (now shown for both add & edit) -->
      <div class="field">
        <label>Sold price</label>
        <input name="sold_price" type="number" inputmode="decimal" step="0.01" min="0"
               value="{{ '%.2f'|format(item.sold_price) if item and item.sold_price is not none else '' }}" />
      </div>

      <!-- Sold date -->
      <div class="field">
        <label>Sold date</label>
        <input name="sold_date" type="date"
               value="{{ item.sold_date.strftime('%Y-%m-%d') if item and item.sold_date else '' }}" />
      </div>

      <!-- Notes -->
      <div class="field" style="grid-column:1/-1;">
        <label>Notes</label>
        <textarea name="notes" rows="4" placeholder="Optional details…">{{ item.notes if item else '' }}</textarea>
      </div>

      <!-- Photo (optional; safe to keep even if you don't use it yet) -->
      <div class="field" style="grid-column:1/-1;">
        <label>Photo</label>
        <input type="file" name="photo" accept="image/*" />
        {% if item and item.photo_path %}
          <div class="muted small" style="margin-top:6px;">Current: {{ item.photo_path }}</div>
        {% endif %}
      </div>

      <!-- Actions -->
      <div style="grid-column:1/-1;display:flex;gap:10px;justify-content:flex-end;">
        <a class="btn outline" href="{{ url_for('item_detail', item_id=item.id) if item else url_for('dashboard') }}">Cancel</a>
        <button class="btn" type="submit">{{ 'Save changes' if item else 'Create item' }}</button>
      </div>
    </form>
  </div>
</section>

{% endblock %}
