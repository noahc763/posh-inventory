{% extends "base.html" %}
{% block content %}
{% set prefill = prefill or {} %}
<section class="card" style="max-width: 760px; margin: 0 auto;">
  <div class="card-header" style="display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;">
    <h2 style="margin:0;">
      {% if read_only %}Item Details{% elif item %}Edit Item{% else %}New Item{% endif %}
    </h2>

    {% if read_only and item %}
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <a class="btn" href="{{ url_for('items.edit_item', item_id=item.id) }}">Edit</a>
        <form method="post" action="{{ url_for('items.bulk_delete_items') }}"
              onsubmit="return confirm('Delete this item permanently?');" style="display:inline">
          <input type="hidden" name="ids" value="{{ item.id }}">
          <button class="btn danger" type="submit">Delete</button>
        </form>
        <a class="btn outline" href="{{ url_for('dashboard') }}">Back</a>
      </div>
    {% endif %}
  </div>

  <div class="card-body">

    {% if read_only and item %}
      {# ================= READ-ONLY DETAIL ================= #}
      <style>
        .detail-grid{display:grid;grid-template-columns: 160px 1fr; gap:14px; align-items:start}
        .detail-photo{width:160px;height:160px;border-radius:10px;overflow:hidden;background:#eef2f7;border:1px solid #d9e0ea}
        .detail-photo img{width:100%;height:100%;object-fit:cover;image-orientation:from-image}
        .detail-row{display:grid;grid-template-columns:180px 1fr;gap:10px}
        .detail-label{color:#475569}
      </style>

      <div class="detail-grid">
        <div>
          {% if item.photo_path %}
            {% set p = item.photo_path | trim %}
            {% set img_url = p %}
            {% if p and not (p.startswith('http://') or p.startswith('https://')) %}
              {% if p.startswith('/static/') %}
                {% set img_url = p %}
              {% else %}
                {% set rel = p.lstrip('/') %}
                {% set img_url = url_for('static', filename=rel) %}
              {% endif %}
            {% endif %}
            <div class="detail-photo">
              <img src="{{ img_url }}" alt="Photo of {{ item.title or item.name }}">
            </div>
          {% endif %}
        </div>

        <div style="display:grid;gap:10px;">
          <div class="detail-row">
            <div class="detail-label">Title</div><div>{{ item.title }}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Category</div><div>{{ item.category.name if item.category else '—' }}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Barcode</div><div>{{ item.barcode or '—' }}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Purchase Price</div>
            <div>{% if item.purchase_price is not none %}${{ '%.2f'|format(item.purchase_price) }}{% else %}—{% endif %}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">List Price</div>
            <div>{% if item.list_price is not none %}${{ '%.2f'|format(item.list_price) }}{% else %}—{% endif %}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Sold Price</div>
            <div>{% if item.sold_price is not none %}${{ '%.2f'|format(item.sold_price) }}{% else %}—{% endif %}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Sold Date</div>
            <div>{{ item.sold_date.strftime('%Y-%m-%d') if item.sold_date else '—' }}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Purchase Date</div>
            <div>{{ item.purchase_date.strftime('%Y-%m-%d') if item.purchase_date else '—' }}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Purchase Source</div>
            <div>{{ item.purchase_source or '—' }}</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Notes</div>
            <div>{{ item.notes or '—' }}</div>
          </div>
        </div>
      </div>

    {% else %}
      {# ================= ADD / EDIT FORM ================= #}
      <form
        method="post"
        enctype="multipart/form-data"
        action="{% if item %}{{ url_for('items.edit_item', item_id=item.id) }}{% else %}{{ url_for('items.add_item') }}{% endif %}"
        class="form"
        style="display:grid;gap:14px;"
      >

        <!-- Category -->
        <label class="field">
          <span>Category *</span>
          <select id="category_id" name="category_id" required>
            <option value="" disabled {% if not item and not prefill.category_id %}selected{% endif %}>— Select —</option>
            {% for c in categories %}
              <option value="{{ c.id }}"
                {% if item and item.category_id == c.id %}selected{% elif prefill.category_id and prefill.category_id|string == c.id|string %}selected{% endif %}>
                {{ c.name }}
              </option>
            {% endfor %}
          </select>
        </label>

        <!-- Title -->
        <label class="field">
          <span>Title *</span>
          <input name="title" value="{{ item.title if item else '' }}" placeholder="e.g., Nike Air Max 270" required />
        </label>

        <!-- Barcode -->
        <label class="field">
          <span>Barcode (UPC/EAN)</span>
          <input name="barcode" value="{% if item %}{{ item.barcode or '' }}{% else %}{{ prefill.barcode or '' }}{% endif %}" placeholder="Scan or type" />
        </label>

        <!-- Prices -->
        <div class="grid-2">
          <label class="field">
            <span>Purchase price *</span>
            <input id="purchase_price" name="purchase_price" type="number" step="0.01" min="0"
                   inputmode="decimal" autocomplete="off"
                   value="{{ '%.2f'|format(item.purchase_price) if item and item.purchase_price is not none }}"
                   placeholder="0.00" required />
          </label>

          <label class="field">
            <span>List price</span>
            <input id="list_price" name="list_price" type="number" step="0.01" min="0"
                   inputmode="decimal" autocomplete="off"
                   value="{{ '%.2f'|format(item.list_price) if item and item.list_price is not none }}"
                   placeholder="0.00" />
            <span class="small muted">Auto-fills with breakeven; you can change it.</span>
          </label>
        </div>

        <!-- Live fee & profit (based on current List price) -->
        <div class="grid-2">
          <label class="field">
            <span>Estimated Poshmark fee (auto)</span>
            <input id="fee" type="number" step="0.01" min="0" placeholder="0.00" readonly />
          </label>

          <label class="field">
            <span>Estimated profit (auto)</span>
            <input id="profit" type="number" step="0.01" placeholder="0.00" readonly />
          </label>
        </div>

        <!-- Optional sold fields -->
        <div class="grid-2">
          <label class="field">
            <span>Sold price</span>
            <input id="sold_price" name="sold_price" type="number" step="0.01" min="0"
                   inputmode="decimal" autocomplete="off"
                   value="{{ '%.2f'|format(item.sold_price) if item and item.sold_price is not none }}"
                   placeholder="0.00" />
            <span class="small muted" id="soldProfitHint"></span>
          </label>

          <label class="field">
            <span>Sold date</span>
            <input name="sold_date" type="date"
                   value="{{ item.sold_date.strftime('%Y-%m-%d') if item and item.sold_date }}" />
          </label>
        </div>

        <!-- Dates / Source -->
        <div class="grid-2">
          <label class="field">
            <span>Purchase date</span>
            <input name="purchase_date" type="date"
                   value="{{ item.purchase_date.strftime('%Y-%m-%d') if item and item.purchase_date }}" />
          </label>

          <label class="field">
            <span>Purchase source</span>
            <input name="purchase_source" value="{{ item.purchase_source if item else '' }}" placeholder="e.g., Thrift store" />
          </label>
        </div>

        <!-- Notes -->
        <label class="field">
          <span>Notes</span>
          <textarea name="notes" rows="3" placeholder="Details, flaws, etc.">{{ item.notes if item else '' }}</textarea>
        </label>

        <!-- Photo -->
        <label class="field">
          <span>Photo</span>
          <input name="photo" type="file" accept="image/*" />
          {% if item and item.photo_path %}
            {% set p = (item.photo_path or '')|trim %}
            {% if p.startswith('http://') or p.startswith('https://') %}
              {% set img_url = p %}
            {% else %}
              {% set img_url = url_for('static', filename=p.lstrip('/')) %}
            {% endif %}
            <div style="margin-top:8px;">
              <img src="{{ img_url }}" alt="Current photo" style="max-width:140px;border-radius:8px;">
            </div>
          {% endif %}
        </label>
        

        <div style="display:flex; gap:8px; margin-top:8px;">
          <button class="btn" type="submit">Save Item</button>
          <a class="btn outline" href="{{ url_for('dashboard') }}" role="button">Cancel</a>
        </div>
      </form>
    {% endif %}
  </div>
</section>

{% if not read_only %}
<script>
  // ------- Helpers -------
  function asNum(el){
    const v = parseFloat((el?.value || '').replace(/[^\d.]/g,''));
    return isNaN(v) ? 0 : v;
  }
  function ceil2(x){ return Math.ceil(x * 100) / 100; }
  // Poshmark fee: $2.95 if price < $15, else 20%
  function poshFee(price){ if (price <= 0) return 0; return price < 15 ? 2.95 : price * 0.20; }
  // Breakeven (min list so that list - fee(list) - purchase >= 0)
  function breakeven(purchase){
    if (purchase <= 0) return 0;
    const flat = purchase + 2.95;
    if (flat < 15) return ceil2(flat);
    const percent = Math.max(15, purchase / 0.8);
    return ceil2(percent);
  }

  const purchaseEl = document.getElementById('purchase_price');
  const listEl     = document.getElementById('list_price');
  const feeEl      = document.getElementById('fee');
  const profitEl   = document.getElementById('profit');
  const soldEl     = document.getElementById('sold_price');
  const soldHint   = document.getElementById('soldProfitHint');

  let userEditedList = false;
  listEl?.addEventListener('input', () => { userEditedList = true; recalc(); });

  function recalc(){
    const purchase = asNum(purchaseEl);
    const list     = asNum(listEl);

    if (!userEditedList && (!list || list === 0) && purchase > 0) {
      const be = breakeven(purchase);
      listEl.value = be ? be.toFixed(2) : '';
    }

    const curList = asNum(listEl);
    const fee  = poshFee(curList);
    feeEl.value    = curList ? fee.toFixed(2) : '';
    const profit = curList ? (curList - fee - purchase) : 0;
    profitEl.value = curList ? profit.toFixed(2) : '';

    const sold = asNum(soldEl);
    if (sold > 0) {
      const soldFee = poshFee(sold);
      const realized = sold - soldFee - purchase;
      soldHint.textContent = `Estimated realized profit at Sold price: $${realized.toFixed(2)}`;
    } else {
      soldHint.textContent = '';
    }
  }

  purchaseEl?.addEventListener('input', () => { if (!userEditedList) listEl.value=''; recalc(); });
  listEl?.addEventListener('input', recalc);
  soldEl?.addEventListener('input', recalc);
  window.addEventListener('DOMContentLoaded', recalc);
</script>
{% endif %}
{% endblock %}
