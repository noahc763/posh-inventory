{% extends "base.html" %}
{% block content %}

<section class="card" style="max-width: 780px; margin: 0 auto;">
  <div class="card-header" style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
    <h2 style="margin:0;">{{ 'Edit Item' if item else 'New Item' }}</h2>
    <a class="btn outline" href="{{ url_for('dashboard') }}">← Back</a>
  </div>

  <div class="card-body">
    <form
      method="post"
      enctype="multipart/form-data"
      action="{% if item %}{{ url_for('items.edit_item', item_id=item.id) }}{% else %}{{ url_for('items.add_item') }}{% endif %}"
      class="form"
      style="display:grid;grid-template-columns:1fr;gap:14px;"
    >
      <!-- Category -->
      <label class="field">
        <span>Category *</span>
        <select name="category_id" required class="input">
          <option value="" disabled {% if not item and not prefill.category_id %}selected{% endif %}>— Select —</option>
          {% for c in categories %}
            <option value="{{ c.id }}"
              {% if item and item.category_id == c.id %}selected{% elif not item and prefill.category_id and (prefill.category_id|string) == (c.id|string) %}selected{% endif %}>
              {{ c.name }}
            </option>
          {% endfor %}
        </select>
      </label>

      <!-- Title -->
      <label class="field">
        <span>Title *</span>
        <input class="input" name="title" required
               value="{{ item.title if item else '' }}"
               placeholder="e.g., Nike Air Max 270">
      </label>

      <!-- Barcode -->
      <label class="field">
        <span>Barcode (UPC/EAN)</span>
        <input class="input" name="barcode"
               value="{% if item %}{{ item.barcode or '' }}{% else %}{{ prefill.barcode or '' }}{% endif %}"
               placeholder="Scan or type">
      </label>

      <!-- Money (Purchase / List / Sold) -->
      <div class="grid-2">
        <label class="field">
          <span>Purchase Price *</span>
          <input id="purchase_price" class="input" name="purchase_price" type="number" step="0.01" min="0" required
                 value="{{ ('%.2f'|format(item.purchase_price)) if item and item.purchase_price is not none else '' }}"
                 placeholder="0.00">
        </label>

        <label class="field">
          <span>List Price</span>
          <input id="list_price" class="input" name="list_price" type="number" step="0.01" min="0"
                 value="{{ ('%.2f'|format(item.list_price)) if item and item.list_price is not none else '' }}"
                 placeholder="0.00">
          <div class="small muted">If left empty, we'll auto-fill with the Breakeven Price.</div>
        </label>
      </div>

      <div class="grid-2">
        <label class="field">
          <span>Sold Price</span>
          <input id="sold_price" class="input" name="sold_price" type="number" step="0.01" min="0"
                 value="{{ ('%.2f'|format(item.sold_price)) if item and item.sold_price is not none else '' }}"
                 placeholder="0.00">
        </label>

        <label class="field">
          <span>Sold Date</span>
          <input class="input" name="sold_date" type="date"
                 value="{{ item.sold_date.strftime('%Y-%m-%d') if item and item.sold_date }}"/>
        </label>
      </div>

      <!-- Auto-calculated helpers -->
      <div class="grid-2">
        <label class="field">
          <span>Estimated Platform Fee (auto)</span>
          <input id="fee" class="input" name="platform_fee" type="number" step="0.01" min="0" placeholder="0.00" readonly>
        </label>

        <label class="field">
          <span>Estimated Profit (auto)</span>
          <input id="profit" class="input" type="number" step="0.01" placeholder="0.00" readonly>
        </label>
      </div>

      <label class="field">
        <span>Breakeven Price (auto)</span>
        <input id="breakeven_price" class="input" type="number" step="0.01" placeholder="0.00" readonly>
        <span class="small muted">Lowest list price that covers purchase + Poshmark fee ($2.95 under $15, else 20%).</span>
      </label>

      <!-- Dates / Source -->
      <div class="grid-2">
        <label class="field">
          <span>Purchase Date</span>
          <input class="input" name="purchase_date" type="date"
                 value="{{ item.purchase_date.strftime('%Y-%m-%d') if item and item.purchase_date }}"/>
        </label>

        <label class="field">
          <span>Purchase Source</span>
          <input class="input" name="purchase_source"
                 value="{{ item.purchase_source if item and item.purchase_source else '' }}"
                 placeholder="e.g., Thrift store, consignment, etc.">
        </label>
      </div>

      <!-- Notes -->
      <label class="field">
        <span>Notes</span>
        <textarea class="input" name="notes" rows="3" placeholder="Details, flaws, etc.">{{ item.notes if item and item.notes else '' }}</textarea>
      </label>

      <!-- Photo -->
      <label class="field">
        <span>Photo</span>
        <input class="input" name="photo" type="file" accept="image/*">
        {% if item and item.photo_path %}
          <div class="small muted" style="margin-top:6px;">Current photo: {{ item.photo_path }}</div>
        {% endif %}
      </label>

      <div style="display:flex; gap:8px; margin-top:8px;">
        <button class="btn" type="submit">{{ 'Save Changes' if item else 'Save Item' }}</button>
        <a class="btn outline" href="{{ url_for('dashboard') }}" role="button">Cancel</a>
      </div>
    </form>
  </div>
</section>

<script>
(function(){
  const $ = (id) => document.getElementById(id);

  const purchaseEl = $('purchase_price');
  const listEl     = $('list_price');    // IMPORTANT: list_price (not listing_price)
  const soldEl     = $('sold_price');
  const feeEl      = $('fee');
  const profitEl   = $('profit');
  const breakEl    = $('breakeven_price');

  function numOf(el){
    if (!el) return 0;
    const v = parseFloat(String(el.value || '').replace(/[^\d.]/g,''));
    return isNaN(v) ? 0 : v;
  }
  function ceil2(x){ return Math.ceil(x * 100) / 100; }

  // Poshmark fee: $2.95 if price < $15, else 20%
  function poshFee(price){
    if (price <= 0) return 0;
    return price < 15 ? 2.95 : price * 0.20;
  }

  // Breakeven based on purchase price only (matches server)
  function breakeven(purchase){
    if (purchase <= 0) return 0;
    const flatCandidate = purchase + 2.95;
    if (flatCandidate < 15) return ceil2(flatCandidate);
    const percentCandidate = purchase / 0.8;
    return ceil2(Math.max(15, percentCandidate));
  }

  function recalc(){
    const purchase = numOf(purchaseEl);
    const list     = numOf(listEl);
    const sold     = numOf(soldEl);

    // If a sold price exists, compute fee/profit from SOLD; else from LIST.
    const basis  = sold > 0 ? sold : list;
    const fee    = poshFee(basis);
    const profit = basis > 0 ? (basis - fee - purchase) : 0;

    if (feeEl)    feeEl.value    = basis > 0 ? fee.toFixed(2) : '';
    if (profitEl) profitEl.value = basis > 0 ? profit.toFixed(2) : '';

    // Breakeven only depends on purchase price
    if (breakEl)  breakEl.value  = purchase > 0 ? breakeven(purchase).toFixed(2) : '';

    // If list price is empty, auto-fill with breakeven (client-side)
    if (listEl && !listEl.value && purchase > 0) {
      listEl.value = breakeven(purchase).toFixed(2);
    }
  }

  ['input','change'].forEach(ev => {
    purchaseEl?.addEventListener(ev, recalc);
    listEl?.addEventListener(ev, recalc);
    soldEl?.addEventListener(ev, recalc);
  });

  // Initial calculation after page loads
  window.addEventListener('DOMContentLoaded', recalc);
})();
</script>

{% endblock %}
